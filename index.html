<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EDA Data Processor</title>

<!-- PapaParse CSV Parser -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 1600px;
    margin: 0 auto;
    padding: 20px;
    background: #f5f5f5;
}

.card {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.upload-zone {
    border: 2px dashed #aaa;
    padding: 40px;
    text-align: center;
    background: #fafafa;
    cursor: pointer;
    border-radius: 10px;
    margin-bottom: 15px;
}

button {
    padding: 12px 24px;
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

button:disabled {
    background: #b8b8b8;
    cursor: not-allowed;
}

.success-btn {
    background: #10b981;
}

table {
    width:100%;
    border-collapse: collapse;
    margin-top:20px;
}

th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align:center;
}
</style>
</head>

<body>

<div class="card">
    <h1>EDA Data Processor</h1>

    <div class="upload-zone" onclick="document.getElementById('files').click()">
        <p style="font-size:50px;margin:0;">üìÅ</p>
        <p><strong>Click to upload files</strong></p>
        <p id="fileInfo" style="color:green;font-weight:bold;"></p>
    </div>

    <input type="file" id="files" multiple accept=".csv" style="display:none;">

    <button id="processBtn" disabled onclick="processAll()">Process Files</button>
    <button id="downloadBtn" class="success-btn" style="display:none;" onclick="downloadCSV()">Download Master Sheet</button>

    <div id="progress"></div>
    <div id="results"></div>
</div>

<script>
let files = [];
let results = [];

/* -------------------- FILE SELECTION --------------------- */
document.getElementById("files").addEventListener("change", e => {
    files = Array.from(e.target.files);
    document.getElementById("fileInfo").textContent = files.length + " files selected";
    document.getElementById("processBtn").disabled = false;
});

/* -------------------- MAIN PROCESSOR --------------------- */
async function processAll() {
    results = [];
    document.getElementById("downloadBtn").style.display = "none";

    for (let i = 0; i < files.length; i++) {
        updateProgress(i+1, files.length);
        const data = await parseCSV(files[i]);
        const metrics = extractMetrics(files[i].name, data);
        results.push(metrics);
    }

    showResults();
    document.getElementById("downloadBtn").style.display = "inline-block";
}

function updateProgress(count, total) {
    const pct = Math.round(count / total * 100);
    document.getElementById("progress").innerHTML =
        `<p>Processing ${count}/${total} (${pct}%)</p>`;
}

/* -------------------- PARSE CSV --------------------- */
function parseCSV(file) {
    return new Promise(resolve => {
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: r => resolve(r.data)
        });
    });
}

/* -------------------- EXTRACT METRICS --------------------- */
function extractMetrics(filename, data) {

    const id = filename.replace(/\.(csv|txt)$/i, "")
                       .replace("_period_analysis_summary", "");
    const name = id;

    // Remove Duration column
    data = data.map(r => { if (r) { delete r.Duration; delete r.duration; } return r; });

    let baseline      = data.find(r => String(r.Period).toLowerCase().includes("task 0"));
    let conditioning  = data.find(r => String(r.Period).toLowerCase().includes("task 1"));
    let counterParts  = data.filter(r => String(r.Period).toLowerCase().includes("task 5"));
    let pgq           = data.find(r => String(r.Period).toLowerCase().includes("task 7"));

    function findColumn(row, key) {
        if (!row) return null;
        return Object.keys(row).find(col => col.toLowerCase().includes(key.toLowerCase()));
    }
    function metric(row, key) {
        if (!row) return "N/A";
        const col = findColumn(row, key);
        return col ? row[col] : "N/A";
    }
    function meanMetric(rows, key) {
        if (!rows || rows.length === 0) return "N/A";
        const col = findColumn(rows[0], key);
        if (!col) return "N/A";
        const nums = rows.map(r => Number(r[col]) || 0);
        return (nums.reduce((a,b)=>a+b,0) / nums.length).toFixed(6);
    }

    return {
        id,
        name,

        baseline: {
            meanSCL: metric(baseline, "mean scl"),
            meanSCR: metric(baseline, "mean scr"),
            scrFreq: metric(baseline, "scr freq"),
            totalSCR: metric(baseline, "total scr"),
            sclSlope: metric(baseline, "scl slope"),
            nsSCL: metric(baseline, "ns-scl"),
            sclStd: metric(baseline, "scl std"),
            scrStd: metric(baseline, "scr std")
        },

        conditioning: {
            meanSCL: metric(conditioning, "mean scl"),
            meanSCR: metric(conditioning, "mean scr"),
            scrFreq: metric(conditioning, "scr freq"),
            totalSCR: metric(conditioning, "total scr"),
            sclSlope: metric(conditioning, "scl slope"),
            nsSCL: metric(conditioning, "ns-scl"),
            sclStd: metric(conditioning, "scl std"),
            scrStd: metric(conditioning, "scr std")
        },

        counterconditioning: {
            meanSCL: meanMetric(counterParts, "mean scl"),
            meanSCR: meanMetric(counterParts, "mean scr"),
            scrFreq: meanMetric(counterParts, "scr freq"),
            totalSCR: meanMetric(counterParts, "total scr"),
            sclSlope: meanMetric(counterParts, "scl slope"),
            nsSCL: meanMetric(counterParts, "ns-scl"),
            sclStd: meanMetric(counterParts, "scl std"),
            scrStd: meanMetric(counterParts, "scr std")
        },

        pgq: {
            meanSCL: metric(pgq, "mean scl"),
            meanSCR: metric(pgq, "mean scr"),
            scrFreq: metric(pgq, "scr freq"),
            totalSCR: metric(pgq, "total scr"),
            sclSlope: metric(pgq, "scl slope"),
            nsSCL: metric(pgq, "ns-scl"),
            sclStd: metric(pgq, "scl std"),
            scrStd: metric(pgq, "scr std")
        }
    };
}

/* -------------------- PREVIEW TABLE --------------------- */
function showResults() {

    let html = `
    <h3>Preview (first 10 rows)</h3>
    <table>
        <thead>
        <tr>
            <th>ID</th><th>Name</th>

            <th>SCL Base</th><th>SCL Cond</th><th>SCL Counter</th><th>SCL PGQ</th>
            <th>SCR Base</th><th>SCR Cond</th><th>SCR Counter</th><th>SCR PGQ</th>

            <th>Freq Base</th><th>Freq Cond</th><th>Freq Counter</th><th>Freq PGQ</th>
            <th>Total Base</th><th>Total Cond</th><th>Total Counter</th><th>Total PGQ</th>

            <th>Slope Base</th><th>Slope Cond</th><th>Slope Counter</th><th>Slope PGQ</th>

            <th>NS Base</th><th>NS Cond</th><th>NS Counter</th><th>NS PGQ</th>

            <th>SCL Std Base</th><th>SCL Std Cond</th><th>SCL Std Counter</th><th>SCL Std PGQ</th>

            <th>SCR Std Base</th><th>SCR Std Cond</th><th>SCR Std Counter</th><th>SCR Std PGQ</th>
        </tr>
        </thead><tbody>
    `;

    results.slice(0,10).forEach(r => {
        html += `
        <tr>
            <td>${r.id}</td><td>${r.name}</td>

            <td>${r.baseline.meanSCL}</td><td>${r.conditioning.meanSCL}</td><td>${r.counterconditioning.meanSCL}</td><td>${r.pgq.meanSCL}</td>
            <td>${r.baseline.meanSCR}</td><td>${r.conditioning.meanSCR}</td><td>${r.counterconditioning.meanSCR}</td><td>${r.pgq.meanSCR}</td>

            <td>${r.baseline.scrFreq}</td><td>${r.conditioning.scrFreq}</td><td>${r.counterconditioning.scrFreq}</td><td>${r.pgq.scrFreq}</td>

            <td>${r.baseline.totalSCR}</td><td>${r.conditioning.totalSCR}</td><td>${r.counterconditioning.totalSCR}</td><td>${r.pgq.totalSCR}</td>

            <td>${r.baseline.sclSlope}</td><td>${r.conditioning.sclSlope}</td><td>${r.counterconditioning.sclSlope}</td><td>${r.pgq.sclSlope}</td>

            <td>${r.baseline.nsSCL}</td><td>${r.conditioning.nsSCL}</td><td>${r.counterconditioning.nsSCL}</td><td>${r.pgq.nsSCL}</td>

            <td>${r.baseline.sclStd}</td><td>${r.conditioning.sclStd}</td><td>${r.counterconditioning.sclStd}</td><td>${r.pgq.sclStd}</td>

            <td>${r.baseline.scrStd}</td><td>${r.conditioning.scrStd}</td><td>${r.counterconditioning.scrStd}</td><td>${r.pgq.scrStd}</td>
        </tr>
        `;
    });

    html += "</tbody></table>";
    document.getElementById("results").innerHTML = html;
}

/* -------------------- CSV EXPORT --------------------- */
function downloadCSV() {

    const header = [
        "ID","Name",

        "SCL Base","SCL Cond","SCL Counter","SCL PGQ",
        "SCR Base","SCR Cond","SCR Counter","SCR PGQ",

        "Freq Base","Freq Cond","Freq Counter","Freq PGQ",

        "Total Base","Total Cond","Total Counter","Total PGQ",

        "Slope Base","Slope Cond","Slope Counter","Slope PGQ",

        "NS Base","NS Cond","NS Counter","NS PGQ",

        "SCL Std Base","SCL Std Cond","SCL Std Counter","SCL Std PGQ",

        "SCR Std Base","SCR Std Cond","SCR Std Counter","SCR Std PGQ"
    ];

    const rows = results.map(r => [
        r.id, r.name,

        r.baseline.meanSCL, r.conditioning.meanSCL, r.counterconditioning.meanSCL, r.pgq.meanSCL,
        r.baseline.meanSCR, r.conditioning.meanSCR, r.counterconditioning.meanSCR, r.pgq.meanSCR,

        r.baseline.scrFreq, r.conditioning.scrFreq, r.counterconditioning.scrFreq, r.pgq.scrFreq,

        r.baseline.totalSCR, r.conditioning.totalSCR, r.counterconditioning.totalSCR, r.pgq.totalSCR,

        r.baseline.sclSlope, r.conditioning.sclSlope, r.counterconditioning.sclSlope, r.pgq.sclSlope,

        r.baseline.nsSCL, r.conditioning.nsSCL, r.counterconditioning.nsSCL, r.pgq.nsSCL,

        r.baseline.sclStd, r.conditioning.sclStd, r.counterconditioning.sclStd, r.pgq.sclStd,

        r.baseline.scrStd, r.conditioning.scrStd, r.counterconditioning.scrStd, r.pgq.scrStd
    ]);

    const csv = [header, ...rows].map(r => r.join(",")).join("\n");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
    a.download = "EDA_MASTER_SHEET.csv";
    a.click();
}
</script>

</body>
</html>

